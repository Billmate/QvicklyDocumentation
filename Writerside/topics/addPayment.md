# addPayment

addPayment is used for creating payments.

> Note: For card and bank payment, a payment url is returned to which the customer must be redirected to finalize the payment.

> Note: For Factoring and Part Payment, billing and shipping address must be same as registered address (swedish: bokföringsadress) to be approved.

## Request parameters
The data section of the payload has the following sub-sections:
* PaymentData
* PaymentInfo
* Card
* Customer
* Articles
* Cart
Please note that not all sections are mandatory. See the documentation for each section for more information.

### PaymentData

| Property      | Required | Type   | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
|---------------|----------|--------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| method        | true     | int    | Payment method. Allowed values: 1= Invoice Factoring, 2=Invoice Service, 4=Invoice Part Payment, 8=Card, 16=Bank, 32=Cash (Receipt) and 1024=Swish.                                                                                                                                                                                                                                                                                                                            |
| country       | true     | string | Country code for the country where purchase is made (normally store location) according to ISO 3166-1 alpha-2, e.g. SE, DK, NO,GB.                                                                                                                                                                                                                                                                                                                                             |
| language      | true     | string | Language code for the language used on the invoice/recipt according to ISO 639-1, Currently supported: sv, da, no, en.                                                                                                                                                                                                                                                                                                                                                         |
| orderid       | true     | string | A unique order id generated by the shop as a reference.                                                                                                                                                                                                                                                                                                                                                                                                                        |
| currency      | true     | string | Currency code to be used for the payment according to ISO 4217. Currently supported: SEK, DKK, NOK, GBP, EUR, USD. Note: Method=16 (Bank) currently only accepts SEK and Method=4 (Part Payment) currently only accepts SEK.                                                                                                                                                                                                                                                   |
| autoactivate  | false    | string | Flag showing if the payment should be auto activated, thus if set, payment is finalized and no activatePayment command is required. For invoice, service and partpayment, autoactivation=1 locks invoice, sends it to Billmate. For invoice and service an invoice will be sent to the given customer email. For card/bank payment, autoactivate=1 captures amount immediately. Default=0. You can also enter a date for when the payment should be activated e.g. 2015-02-28. |
| logo          | false    | string | Change logo for the payment. You will find the reference to your logo in your billmate online account. You will find it in Settings -> Company details -> Company logo. The reference to be used is the file name e.g. Logo1.jpg. If left empty the standard logo will be used.                                                                                                                                                                                                |
| paymentplanid | false    | int    | Paymentplan id of the selected part payment plan. Required if paymentmethod is PartPayment. If you wish to use a different currency for part payment than SEK, please contact us by clicking on this link.                                                                                                                                                                                                                                                                     |


### PaymentInfo
| Property      | Required | Type    | Description                                                                                                                               |
|---------------|----------|---------|-------------------------------------------------------------------------------------------------------------------------------------------|
| paymentdate   | false    | date    | Payment date in invoice/receipt on format YYYY-MM-DD. Default is current date.                                                            | 
| paymentterms  | false    | int     | Payment terms field in invoice/receipt. Given in number of days.                                                                          | 
| yourreference | false    | string  | Your reference field in invoice/receipt.                                                                                                  | 
| ourreference  | false    | string  | Our reference field in invoice/receipt.                                                                                                   |
| projectname   | false    | string  | Project name field in invoice/receipt.                                                                                                    |                                                             |delivery	false	string	Delivery method. Post, etc.
| deliveryterms | false    | string  | Delivery terms field in invoice/receipt. FOB, etc.                                                                                        |                                                            
| autocredit    | false    | boolean | If this is set to true, then if the invoice is not paid before the duedate, the invoice will be automatically credited. Default is false. | 

### Card
| Property     | Required | Type   | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
|--------------|----------|--------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| promptname   | false    | int    | Flag indicating if name should be prompted in payment window. Only valid for card payments (method=8). Default=0 (no prompt).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| recurring    | false    | int    | Flag indicating if card payment is or should be saved to make it possible to do recurring payments, like monthly subscriptions. If set, then after first payment has been made, an addPayment call will make another card payment automatically. Requires a special aquirer agreement (inlösenavtal). Only valid for card payments (method=8). Default=0 (no recurring payment). Notice that this is only needed for the initial recurring payment.                                                                                                                                                                 |
| recurringnr  | false    | int    | Payment number (datanumber) received from first purchase for making a recurring payment.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| accepturl    | false    | string | Url to which the customer is redirected after a completed payment. Data returned is same as for addPayment defined below.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| cancelurl    | false    | string | Url to which the customer is redirected after a failed or cancelled payment. Data returned is error message and code as for addPayment defined below.                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| returnmethod | false    | string | Http return method to accepturl, cancelurl and callbackurl. Default is ‘POST’, but can be set to ‘GET’ instead.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| callbackurl  | false    | string | Url to which callback data is sent after the customer has succesfully completed a card or bank payment. Data returned is same as for addPayment defined below and for accepturl. Callback is made same time as accepturl, thus it can’t be assumed that callback data will arrive before accepturl data. No response is required to a callback request, the data just has to be received. If callback data is not received, Billmate server will try to send callback data again once a minute first 10 minutes, once an hour first 10 hours, once a day first 7 days, then finally once a month for next 3 months. |

### Customer
| Property | Required | Type   | Description                                                                                                                                                                                                                                                                                         |
|----------|----------|--------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| nr       | false    | int    | Customer number. If not given, next available customer number in Billmate will be assigned.                                                                                                                                                                                                         |
| pno      | false    | string | national identification number number or swedish organization number. Sent as YYMMDD-XXXX, it can be sent with or without “-” and with or without the two first numbers (19 or 20) in the year. Mandatory field for Factoring and PartPayment methods, but not for receipt, card and bank payments. |

#### Customer - Billing address
| Property | Required | Type   | Description                                                                                                                                                                                                                                                                                         |
|----------|----------|--------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|

#### Customer - Shipping address
| Property | Required | Type   | Description                                                                                                                                                                                                                                                                                         |
|----------|----------|--------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|

### Articles
Articles are an array of objects with the following properties:

| Property   | Required | Type   | Description                                                                                                                                                                                                                                                                                                                                                                                |
|------------|----------|--------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| taxrate    | true     | dec    | Article tax rate in percent.                                                                                                                                                                                                                                                                                                                                                               |
| withouttax | true     | dec    | Total article row excluding tax in 1/100 of currency (i.e. öre if currency is SEK, cent if currency is EUR). Amount given will overwrite any errors in rounding of articles row sum. Mandatory since at least one article is required to add up to total.withouttax. Note When a discount is applicable on the article, you have to deduct the discount amount from the withouttax amount. |
| artnr      | false    | string | Article number.                                                                                                                                                                                                                                                                                                                                                                            |
| title      | true     | string | Article description.                                                                                                                                                                                                                                                                                                                                                                       |
| quantity   | false    | dec    | Article quantity.                                                                                                                                                                                                                                                                                                                                                                          |
| aprice     | false    | dec    | Article unit price without tax in 1/100 of currency (i.e. öre if currency is SEK, cent if currency is EUR).                                                                                                                                                                                                                                                                                |
| discount   | false    | dec    | Article discount in %.                                                                                                                                                                                                                                                                                                                                                                     |

> The sum of all articles withouttax must be equal to Cart.Total.withouttax.

> The sum of all articles tax (withouttax * taxrate / 100) must be equal to Cart.Total.tax.


## Request example
```json
{
  "credentials": {
    "id": "12345",
    "hash": "24632112c18c6fbf7fce6409deda1d4824140c0059fbc108ed6190934c47709caffcb8f8c47fd770ab53e4637e5dac1b8679faa30a248353775dbf336a67d202",
    "version": "%API_VERSION%",
    "client": "Pluginname:Qvickly:1.0",
    "language": "sv",
    "serverdata": {"HTTP_HOST":"developer.billmate.se","HTTP_CONNECTION":"keep-alive","HTTP_CACHE_CONTROL":"max-age=0","HTTP_ACCEPT":"text\/html,application\/xhtml+xml,application\/xml;q=0.9,image\/webp,*\/*;q=0.8","HTTP_USER_AGENT":"Mozilla\/5.0 (Macintosh; Intel Mac OS X 10_10_1) AppleWebKit\/537.36 (KHTML, like Gecko) Chrome\/39.0.2171.95 Safari\/537.36","HTTP_ACCEPT_ENCODING":"gzip, deflate, sdch","HTTP_ACCEPT_LANGUAGE":"en-US,en;q=0.8","PATH":"\/sbin:\/usr\/sbin:\/bin:\/usr\/bin","SERVER_SOFTWARE":"Apache\/2.2.26 (Amazon)","SERVER_NAME":"developer.billmate.se","SERVER_ADDR":"172.31.22.88","SERVER_PORT":"80","REMOTE_ADDR":"2.71.114.219","REMOTE_PORT":"53241","GATEWAY_INTERFACE":"CGI\/1.1","SERVER_PROTOCOL":"HTTP\/1.1","REQUEST_METHOD":"GET","QUERY_STRING":"","REQUEST_TIME":1421313644},
    "time": "1417004339.9291 ",
    "test": "true"
  },
  "data": {
    "PaymentData": {
      "method": "1",
      "paymentplanid": "",
      "currency": "SEK",
      "language": "sv",
      "country": "SE",
      "autoactivate": "0",
      "orderid": "P123456789",
      "logo": "Logo2.jpg"
    },
    "PaymentInfo": {
      "paymentdate": "2014-07-31",
      "paymentterms": "14",
      "yourreference": "Purchaser X",
      "ourreference": "Seller Y",
      "projectname": "Project Z",
      "deliverymethod": "Post",
      "deliveryterms": "FOB",
      "autocredit": "false"
    },
    "Card": {
      "promptname": "",
      "recurring": "",
      "recurringnr": "",
      "accepturl": "https://www.mystore.se/completedpayment",
      "cancelurl": "https://www.mystore.se/failedpayment",
      "returnmethod": "",
      "callbackurl": "https://www.mystore.se/callback.php"
    },
    "Customer": {
      "nr": "12",
      "pno": "550101-1018",
      "Billing": {
        "firstname": "Testperson",
        "lastname": "Approved",
        "company": "Company",
        "street": "Teststreet",
        "street2": "Street2",
        "zip": "12345",
        "city": "Testcity",
        "country": "SE",
        "phone": "0712-345678",
        "email": "test@developer.billmate.se"
      },
      "Shipping": {
        "firstname": "Testperson",
        "lastname": "Approved",
        "company": "Company",
        "street": "Teststreet",
        "street2": "Shipping Street2",
        "zip": "12345",
        "city": "Testcity",
        "country": "SE",
        "phone": "0711-345678"
      }
    },
    "Articles": [
      {
        "artnr": "A123",
        "title": "Article 1",
        "quantity": "2",
        "aprice": "1234",
        "discount": "0",
        "withouttax": "2468",
        "taxrate": "25"
      },
      {
        "artnr": "B456",
        "title": "Article 2",
        "quantity": "3.5",
        "aprice": "56780",
        "discount": "10",
        "withouttax": "178857",
        "taxrate": "25"
      }
    ],
    "Cart": {
      "Handling": {
        "withouttax": "1000",
        "taxrate": "25"
      },
      "Shipping": {
        "withouttax": "3000",
        "taxrate": "25"
      },
      "Total": {
        "withouttax": "185325",
        "tax": "46331",
        "rounding": "44",
        "withtax": "231700"
      }
    }
  },
  "function": "addPayment"
}
```

## Response example
```json
{
    "credentials": {
        "hash":"0b2d1c4d31228a6dc845a16d57b782b97a5e111db2348324be42f5a91e88c8bd35fa62f0e6240b5680e17da03bb9301c5bd0ed755db7fa62ba6054ee21cdde88"
    }
    "data": {
        "number":"12345",
        "status":"Created",
        "orderid":"P123456789",
        "url":"https://api.qvickly.io/invoice/140544658153c38f1cdf279"
    }
}
```